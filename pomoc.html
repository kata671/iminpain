<!DOCTYPE html>
<html lang="pl" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <title>Niezwłoczna pomoc — znajdź najbliższą pomoc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Twój globalny styl (z nowym ciemnym tłem turkus/fiolet) -->
  <link rel="stylesheet" href="style.css" />

  <!-- Leaflet (mini-mapa) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PWA manifest (opcjonalnie, jeśli dodałaś wcześniej manifest.webmanifest) -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#56338e"/>

  <!-- JAŚNIEJSZA WERSJA TŁA TYLKO NA TEJ STRONIE (mapa czytelniejsza) -->
  <style>
    :root{
      --card-bg: rgba(38,44,90,.74);
      --card-bd: rgba(150,170,255,.28);
    }
    body{
      background-image:
        radial-gradient(1200px 800px at 8% -10%, rgba(20,184,166,.28), transparent 60%),
        radial-gradient(900px 600px  at 110% 10%, rgba(124,58,237,.22), transparent 60%),
        radial-gradient(800px 600px  at 52% 120%, rgba(20,184,166,.22), transparent 60%) !important;
    }
    body::before{ opacity:.22 !important; }

    /* Layout i panele tej strony */
    body{color:#fff; max-width:1100px; margin:0 auto; padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
    a.back{text-decoration:none; color:#eaf2ff;}
    h1{margin:8px 0 12px;text-align:center}
    .note{background:rgba(255,238,170,.18);border:1px solid rgba(255,200,0,.28);padding:10px;border-radius:12px;margin:12px 0}
    .panel{background:var(--card-bg);border:1px solid var(--card-bd);border-radius:14px;padding:14px;margin:14px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    input,textarea,select{padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.15);width:100%;background:#fff;color:#111}
    textarea{min-height:90px;resize:vertical}
    button,.chip,select{border:1px solid rgba(255,255,255,.2);background:#1b1f3a;color:#fff;border-radius:999px;padding:10px 14px;cursor:pointer}
    .chip{background:#23264a}
    .chip.emergency{border-color:#ff5a5a;background:rgba(255,77,77,.12);font-weight:700}
    .chip.small{padding:8px 12px;font-size:.95rem}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(300px,1fr));gap:12px}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
    .muted{opacity:.82}
    .danger{color:#ff8080;font-weight:700}
    footer{margin-top:24px;opacity:.85;font-size:.95rem}
    .bar{display:grid;grid-template-columns:1.5fr 1fr 1fr;gap:10px}
    @media (max-width:900px){.bar{grid-template-columns:1fr}}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .toolbar .group{display:flex;gap:8px;flex-wrap:wrap}
    .section-title{display:flex;align-items:center;gap:8px;margin:6px 0 8px}
    .section-title .hint{font-size:.95rem;opacity:.75}
    .pill{height:6px;border-radius:6px;background:linear-gradient(90deg, rgba(20,184,166,.5), rgba(124,58,237,.5));margin:6px 0 2px}
    .kbd{font-family:ui-monospace,Consolas,monospace;background:#fff;color:#111;border:1px solid rgba(0,0,0,.15);padding:2px 6px;border-radius:6px}
    .card{background:rgba(255,255,255,.04);border:1px solid var(--card-bd);border-radius:14px;padding:12px}
    .card h3{margin:6px 0 10px}
    .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:760px){.mini-grid{grid-template-columns:1fr}}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .list{display:flex;flex-wrap:wrap;gap:8px}
    .list .chip{display:flex;align-items:center;gap:8px}
    .list .chip .del{border:none;background:transparent;cursor:pointer;color:#ff9c9c}
    .theme-toggle{display:flex;align-items:center;gap:8px}
    /* MAPA */
    #mapWrap{height:380px;border-radius:14px;overflow:hidden;border:1px solid var(--card-bd)}
    #map{height:100%;width:100%}
    .map-bar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .badge{border-radius:999px;padding:4px 10px;border:1px solid var(--card-bd);background:rgba(255,255,255,.04)}
    @media print{ header,.note,.panel:not(.printable),footer{display:none!important} .printable{display:block!important;border:1px solid #999;background:#fff;color:#000} body{background:#fff;color:#000} }
    /* focus dla dostępności */
    a,button{outline:none}
    a:focus-visible,button:focus-visible{outline:2px solid #60a5fa;outline-offset:2px;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <a class="back" href="javascript:history.back()">← Wróć</a>
    <h1>Niezwłoczna pomoc</h1>
    <div class="theme-toggle">
      <a class="back" href="index.html">Strona główna →</a>
    </div>
  </header>

  <div class="note">
    <p><strong>W nagłym zagrożeniu życia — dzwoń 112 / 999.</strong> Poniżej szybko znajdziesz najbliższy SOR/szpital/poradnię i wyznaczysz trasę.</p>
  </div>

  <!-- WYSZUKIWARKA -->
  <section class="panel">
    <div class="section-title">
      <h2 style="margin:0">Wyszukaj w Twojej okolicy</h2>
      <span class="hint">np. <span class="kbd">SOR</span>, <span class="kbd">kardiolog dyżur</span>, <span class="kbd">apteka 24h</span></span>
    </div>
    <div class="bar">
      <input id="q" type="text" placeholder="np. SOR, szpital, poradnia kardiologiczna, apteka 24h…" />
      <div class="toolbar">
        <div class="group">
          <select id="platform" title="Platforma map">
            <option value="google" selected>Google Maps</option>
            <option value="apple">Apple Maps</option>
            <option value="osm">OpenStreetMap</option>
          </select>
          <select id="mode" title="Tryb dojazdu">
            <option value="driving" selected>Samochód</option>
            <option value="walking">Pieszo</option>
            <option value="transit">Komunikacja</option>
          </select>
        </div>
      </div>
      <div class="toolbar">
        <div class="group">
          <button id="useLoc">📍 Użyj mojej lokalizacji</button>
          <button id="search">🔎 Szukaj</button>
          <button id="route">🧭 Wyznacz trasę</button>
          <a class="chip emergency" href="tel:112">📞 112</a>
          <a class="chip emergency" href="tel:999">🚑 999</a>
        </div>
      </div>
    </div>
    <p id="locStatus" class="muted" aria-live="polite" style="margin:8px 2px 0"></p>
    <div class="pill"></div>
    <div class="recent-wrap" style="margin-top:10px;display:none">
      <span class="muted" style="margin-right:6px">Ostatnie wyszukiwania:</span>
      <div id="recent" class="list"></div>
    </div>
  </section>

  <!-- MAPA -->
  <section class="panel">
    <div class="section-title" style="justify-content:space-between">
      <div style="display:flex;align-items:center;gap:10px">
        <h2 style="margin:0">Mapa</h2>
        <span class="badge" id="mapStatus">⏳ czekam na lokalizację…</span>
      </div>
      <div class="map-bar">
        <button id="centerMe">🎯 Do mnie</button>
        <button id="centerDest" title="Pokaż ostatni wynik wyszukiwania">📌 Do celu</button>
        <button id="clearDest">🗑 Wyczyść znacznik</button>
      </div>
    </div>
    <div id="mapWrap"><div id="map"></div></div>
    <p class="muted" style="margin-top:8px">Źródło mapy: © OpenStreetMap | Geokodowanie: Nominatim. Szukaj inteligentnie, np. „SOR dziecięcy Gdańsk”.</p>
  </section>

  <!-- FILTRY SPECJALISTÓW -->
  <section class="panel">
    <div class="grid">
      <div>
        <h3>🚨 Najpilniejsze</h3>
        <div class="chips">
          <button class="chip emergency" data-q="SOR (Szpitalny Oddział Ratunkowy)">SOR — Szpitalny Oddział Ratunkowy</button>
          <button class="chip emergency" data-q="Centrum urazowe">Centrum urazowe</button>
          <button class="chip emergency" data-q="SOR dziecięcy">SOR dziecięcy (pediatria)</button>
          <button class="chip emergency" data-q="Oddział udarowy">Oddział udarowy / Centrum udarowe</button>
          <button class="chip emergency" data-q="Izba przyjęć">Izba przyjęć</button>
        </div>

        <h3 style="margin-top:12px">❤️ Kardiologia / 🧠 Neurologia</h3>
        <div class="chips">
          <button class="chip" data-q="Poradnia kardiologiczna">Poradnia kardiologiczna</button>
          <button class="chip" data-q="Kardiologia dyżur">Kardiologia — dyżur</button>
          <button class="chip" data-q="Pracownia hemodynamiki 24h">Pracownia hemodynamiki 24h</button>
          <button class="chip" data-q="Neurologia dyżur">Neurologia — dyżur</button>
          <button class="chip" data-q="Oddział udarowy">Oddział udarowy</button>
        </div>

        <h3 style="margin-top:12px">🧑‍⚕️ Chirurgia / Ortopedia / Urazy</h3>
        <div class="chips">
          <button class="chip" data-q="Poradnia chirurgiczna">Poradnia chirurgiczna</button>
          <button class="chip" data-q="Chirurgia urazowa dyżur">Chirurgia urazowa — dyżur</button>
          <button class="chip" data-q="Ortopeda dyżur">Ortopeda — dyżur</button>
          <button class="chip" data-q="Szycie ran całodobowo">Szycie ran całodobowo</button>
          <button class="chip" data-q="RTG 24h">RTG 24h</button>
          <button class="chip" data-q="Tomografia 24h">Tomografia 24h</button>
          <button class="chip" data-q="Rezonans 24h">Rezonans 24h</button>
        </div>
      </div>

      <div>
        <h3>👶 Ginekologia/położnictwo / 👁️ Okulistyka / 🦷 Stomatologia</h3>
        <div class="chips">
          <button class="chip" data-q="Położnictwo izba przyjęć">Położnictwo — izba przyjęć</button>
          <button class="chip" data-q="Ginekologia dyżur">Ginekologia — dyżur</button>
          <button class="chip" data-q="Okulista dyżur">Okulista — dyżur</button>
          <button class="chip" data-q="SOR okulistyczny">SOR okulistyczny</button>
          <button class="chip" data-q="Stomatologia dyżur">Stomatologia — dyżur</button>
          <button class="chip" data-q="Pogotowie stomatologiczne">Pogotowie stomatologiczne</button>
        </div>

        <h3 style="margin-top:12px">🧪 Toksykologia / 🔥 Oparzenia / 🧠 Psychiatra</h3>
        <div class="chips">
          <button class="chip" data-q="Toksykologia dyżur">Toksykologia — dyżur</button>
          <button class="chip" data-q="Ośrodek ostrych zatruć">Ośrodek ostrych zatruć</button>
          <button class="chip" data-q="Oparzenia oddział">Oddział leczenia oparzeń</button>
          <button class="chip" data-q="Psychiatra dyżur">Psychiatra — dyżur</button>
          <button class="chip" data-q="Całodobowy ośrodek kryzysowy">Całodobowy ośrodek kryzysowy</button>
        </div>

        <h3 style="margin-top:12px">🌙 Nocna pomoc / 🩺 POZ / 💊 Apteki</h3>
        <div class="chips">
          <button class="chip" data-q="Nocna i Świąteczna Opieka Zdrowotna">Nocna i Świąteczna Opieka</button>
          <button class="chip" data-q="Przychodnia POZ">Przychodnia POZ</button>
          <button class="chip" data-q="Poradnia rehabilitacyjna">Poradnia rehabilitacyjna</button>
          <button class="chip" data-q="Fizjoterapia pilna">Fizjoterapia — pilna</button>
          <button class="chip" data-q="Apteka całodobowa">Apteka 24h</button>
        </div>
      </div>
    </div>
  </section>

  <!-- MOJE SZYBKIE NUMERY -->
  <section class="panel">
    <div class="grid">
      <div class="card">
        <h3>📞 Moje szybkie numery</h3>
        <p class="muted" style="margin-top:-4px">Dodaj własne telefony. Wstępnie dodaliśmy kilka ogólnopolskich numerów.</p>
        <div class="mini-grid" style="margin-top:8px">
          <div><label>Nazwa</label><input id="numName" type="text" placeholder="np. SOR Warszawa" /></div>
          <div><label>Telefon</label><input id="numTel" type="tel" placeholder="+48..." /></div>
        </div>
        <div class="btn-row" style="margin-top:8px">
          <button id="addNum">➕ Dodaj</button>
          <button id="clearNums" class="danger" title="Czyści tylko lokalnie">🗑 Wyczyść listę</button>
          <button id="exportNums">⬇️ Export</button>
          <label class="chip" style="cursor:pointer">⬆️ Import <input id="importNums" type="file" accept="application/json" style="display:none"></label>
        </div>
        <div id="numList" class="list" style="margin-top:10px"></div>
      </div>

      <!-- KARTA MEDYCZNA -->
      <div class="card printable" id="cardMedical">
        <h3>🧾 Karta medyczna (do wydruku)</h3>
        <div class="mini-grid">
          <div><label>Imię i nazwisko</label><input id="mc_name" type="text" /></div>
          <div><label>PESEL / Data ur.</label><input id="mc_id" type="text" /></div>
          <div><label>Grupa krwi</label><input id="mc_blood" type="text" placeholder="np. 0 Rh+" /></div>
          <div><label>Kontakt ICE</label><input id="mc_ice" type="text" placeholder="np. Anna 600 000 000" /></div>
        </div>
        <div class="mini-grid" style="margin-top:8px">
          <div><label>Choroby / rozpoznania</label><textarea id="mc_dx"></textarea></div>
          <div><label>Leki i dawki</label><textarea id="mc_rx"></textarea></div>
        </div>
        <div class="mini-grid" style="margin-top:8px">
          <div><label>Alergie / uczulenia</label><textarea id="mc_all"></textarea></div>
          <div><label>Uwagi medyczne</label><textarea id="mc_notes"></textarea></div>
        </div>
        <div class="btn-row" style="margin-top:8px">
          <button id="saveMC">💾 Zapisz</button>
          <button id="printMC">🖨 Drukuj</button>
          <button id="clearMC" class="danger">🗑 Wyczyść</button>
          <button id="exportMC">⬇️ Export</button>
          <label class="chip" style="cursor:pointer">⬆️ Import <input id="importMC" type="file" accept="application/json" style="display:none"></label>
        </div>
        <p class="muted" style="margin-top:6px">Dane zapisują się lokalnie (to urządzenie). Możesz eksportować/importować lub wydrukować do PDF.</p>
      </div>
    </div>
  </section>

  <!-- WSKAZÓWKI -->
  <section class="panel">
    <div class="grid">
      <div>
        <p><strong>Kiedy dzwonić 112 / 999?</strong></p>
        <ul>
          <li>Silny ból w klatce piersiowej z dusznością, zasinienie</li>
          <li>Objawy udaru: asymetria twarzy, osłabienie kończyny, zaburzenia mowy</li>
          <li>Utrata przytomności, masywny krwotok, drgawki</li>
        </ul>
      </div>
      <div>
        <p><strong>Wskazówki na miejscu</strong></p>
        <ul>
          <li>Dokument, PESEL, lista leków/przeciwwskazań, alergie</li>
          <li>Naładowany telefon; nie prowadź jeśli źle się czujesz</li>
          <li>Jeśli można: ostatnie wyniki badań/rozpoznania</li>
        </ul>
      </div>
    </div>
  </section>

  <footer>
    <p>© 2025 Iminpain — Informacje poglądowe. W nagłych stanach zawsze wzywaj <strong>112</strong>. Źródło map: © OpenStreetMap contributors.</p>
  </footer>

  <script>
    (function(){
      /* ====== MAPY / LOKALIZACJA ====== */
      var got=null, destMarker=null, userMarker=null;
      var status=document.getElementById('locStatus');
      var q=document.getElementById('q'), mode=document.getElementById('mode'), platform=document.getElementById('platform');
      var recentWrap=document.querySelector('.recent-wrap'), recentBox=document.getElementById('recent');
      var RECENT_KEY='iminpain_recent_searches_v1';
      var mapStatus=document.getElementById('mapStatus');

      // Leaflet init
      var map=L.map('map',{zoomControl:true});
      var tiles=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19, attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
      map.setView([52.1,19.4], 6); // środek PL
      function setStatus(msg){ status.textContent=msg||""; }
      function setMapStatus(msg){ mapStatus.textContent=msg||""; }

      function saveRecent(term){
        term=(term||"").trim(); if(!term) return;
        var arr=[]; try{arr=JSON.parse(localStorage.getItem(RECENT_KEY)||'[]')}catch(e){}
        arr=[term].concat(arr.filter(x=>x.toLowerCase()!==term.toLowerCase()));
        if(arr.length>10) arr.length=10;
        localStorage.setItem(RECENT_KEY, JSON.stringify(arr)); renderRecent();
      }
      function renderRecent(){
        var arr=[]; try{arr=JSON.parse(localStorage.getItem(RECENT_KEY)||'[]')}catch(e){}
        recentBox.innerHTML=''; if(!arr.length){recentWrap.style.display='none';return;}
        recentWrap.style.display='block';
        arr.forEach(function(t){
          var b=document.createElement('button'); b.className='chip small'; b.textContent=t;
          b.addEventListener('click', function(){ q.value=t; openMapsSearch(t); geocodeToMap(t); });
          recentBox.appendChild(b);
        });
      }

      function openWithPlatform(urlGoogle,urlApple,urlOSM){
        var p=platform.value;
        window.open(p==='apple'?urlApple:(p==='osm'?urlOSM:urlGoogle), '_blank');
      }
      function openMapsSearch(query){
        query=(query&&query.trim())?query.trim():"Szpital"; saveRecent(query);
        var gm,am,om;
        if(got){
          gm="https://www.google.com/maps/search/"+encodeURIComponent(query)+"/@"+got.lat+","+got.lng+",14z";
          am="https://maps.apple.com/?q="+encodeURIComponent(query)+"&sll="+got.lat+","+got.lng+"&z=14";
          om="https://www.openstreetmap.org/?query="+encodeURIComponent(query)+"#map=14/"+got.lat+"/"+got.lng;
        }else{
          gm="https://www.google.com/maps/search/"+encodeURIComponent(query+" blisko mnie");
          am="https://maps.apple.com/?q="+encodeURIComponent(query);
          om="https://www.openstreetmap.org/search?query="+encodeURIComponent(query);
        }
        openWithPlatform(gm,am,om);
      }
      function openMapsRoute(query){
        query=(query&&query.trim())?query.trim():"Szpital"; saveRecent(query);
        var travel=mode.value||'driving';
        var gmMode=travel, amMode=(travel==='walking'?'w':travel==='transit'?'r':'d');
        if(got){
          var gm="https://www.google.com/maps/dir/?api=1&origin="+got.lat+","+got.lng+"&destination="+encodeURIComponent(query)+"&travelmode="+gmMode;
          var am="https://maps.apple.com/?saddr="+got.lat+","+got.lng+"&daddr="+encodeURIComponent(query)+"&dirflg="+amMode;
          var om=gm; // fallback
          openWithPlatform(gm,am,om);
        }else{ openMapsSearch(query); }
      }

      // Geolokalizacja + marker
      function requestLocation(){
        if(!navigator.geolocation){ setStatus("Przeglądarka nie wspiera geolokalizacji."); return; }
        setStatus("Pobieram lokalizację…"); setMapStatus("⏳ pobieram lokalizację…");
        navigator.geolocation.getCurrentPosition(function(pos){
          got={lat:+pos.coords.latitude.toFixed(6), lng:+pos.coords.longitude.toFixed(6)};
          setStatus("Lokalizacja ustawiona ✔ ("+got.lat+", "+got.lng+")");
          setMapStatus("📍 gotowe");
          if(userMarker) map.removeLayer(userMarker);
          userMarker=L.marker([got.lat,got.lng],{title:"Twoja lokalizacja"}).addTo(map);
          map.setView([got.lat,got.lng], 14);
        }, function(err){
          setStatus("Nie udało się pobrać lokalizacji ("+err.message+")."); setMapStatus("⚠️ brak lokalizacji");
        }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
      }

      // Geokodowanie wyniku (Nominatim) i pinezka celu
      async function geocodeToMap(query){
        if(!query) return;
        setMapStatus("🔎 szukam: "+query);
        try{
          const url = "https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(query);
          const resp = await fetch(url, {headers:{'Accept-Language':'pl'}});
          const data = await resp.json();
          if(!data.length){ setMapStatus("❌ nie znaleziono"); return; }
          const p = data[0];
          if(destMarker) map.removeLayer(destMarker);
          destMarker = L.marker([+p.lat, +p.lon], {title: query}).addTo(map);
          map.setView([+p.lat, +p.lon], 14);
          setMapStatus("📌 znaleziono");
        }catch(e){
          setMapStatus("⚠️ błąd wyszukiwania");
        }
      }

      document.getElementById('useLoc').addEventListener('click', requestLocation);
      document.getElementById('search').addEventListener('click', function(){ openMapsSearch(q.value); geocodeToMap(q.value); });
      document.getElementById('route').addEventListener('click', function(){ openMapsRoute(q.value); });
      document.getElementById('centerMe').addEventListener('click', function(){ if(got){ map.setView([got.lat,got.lng], 14); }});
      document.getElementById('centerDest').addEventListener('click', function(){ if(destMarker){ map.setView(destMarker.getLatLng(), 14); }});
      document.getElementById('clearDest').addEventListener('click', function(){ if(destMarker){ map.removeLayer(destMarker); destMarker=null; setMapStatus("🗑 znacznik usunięty"); }});
      document.querySelectorAll('.chip').forEach(function(btn){
        btn.addEventListener('click', function(){
          var query = btn.getAttribute('data-q'); if(query){ q.value=query; openMapsSearch(query); geocodeToMap(query); }
        });
      });
      q.addEventListener('keydown', function(e){ if(e.key==='Enter'){ openMapsSearch(q.value); geocodeToMap(q.value); }});
      setTimeout(function(){ q.focus(); renderRecent(); }, 50);

      /* ====== SZYBKIE NUMERY ====== */
      var NUM_KEY='iminpain_quick_numbers_v1';
      var list=document.getElementById('numList');
      var nName=document.getElementById('numName'); var nTel=document.getElementById('numTel');

      // Predefiniowane, edytowalne (ładowane tylko raz — jeśli storage pusty)
      var PREDEF=[
        {name:"Telefon alarmowy", tel:"112"},
        {name:"Pogotowie ratunkowe", tel:"999"},
        {name:"Centrum Zatruć (Warszawa)", tel:"+48225923066"},
        {name:"Centrum Zatruć (Kraków)", tel:"+48124251852"},
        {name:"Centrum Zatruć (Gdańsk)", tel:"+48583400900"},
        {name:"Centrum Kryzysowe (ogólnopolskie)", tel:"+488004406340"},
        {name:"Telefon Zaufania Młodzieżowy", tel:"+48116011"}
      ];

      function ensurePredef(){
        var arr=[]; try{arr=JSON.parse(localStorage.getItem(NUM_KEY)||'[]')}catch(e){}
        if(!arr.length){ localStorage.setItem(NUM_KEY, JSON.stringify(PREDEF)); }
      }

      function loadNums(){
        ensurePredef();
        var arr=[]; try{arr=JSON.parse(localStorage.getItem(NUM_KEY)||'[]')}catch(e){}
        renderNums(arr);
      }
      function renderNums(arr){
        list.innerHTML='';
        arr.forEach(function(it, idx){
          var a=document.createElement('a'); a.className='chip'; a.href='tel:'+it.tel.replace(/\s+/g,'');
          a.textContent='📞 '+it.name+' — '+it.tel;
          var del=document.createElement('button'); del.className='del'; del.title='Usuń'; del.innerHTML='✖';
          del.addEventListener('click', function(ev){
            ev.preventDefault(); arr.splice(idx,1);
            localStorage.setItem(NUM_KEY, JSON.stringify(arr)); renderNums(arr);
          });
          a.appendChild(del); list.appendChild(a);
        });
      }
      document.getElementById('addNum').addEventListener('click', function(){
        var name=(nName.value||'').trim(); var tel=(nTel.value||'').trim();
        if(!name || !tel) return;
        var arr=[]; try{arr=JSON.parse(localStorage.getItem(NUM_KEY)||'[]')}catch(e){}
        arr.unshift({name, tel}); if(arr.length>20) arr.length=20;
        localStorage.setItem(NUM_KEY, JSON.stringify(arr)); nName.value=''; nTel.value=''; renderNums(arr);
      });
      document.getElementById('clearNums').addEventListener('click', function(){
        if(confirm('Usunąć wszystkie zapisane numery (tylko lokalnie)?')){
          localStorage.removeItem(NUM_KEY); loadNums();
        }
      });
      document.getElementById('exportNums').addEventListener('click', function(){
        try{
          var arr=JSON.parse(localStorage.getItem(NUM_KEY)||'[]');
          var blob=new Blob([JSON.stringify(arr,null,2)],{type:'application/json'});
          var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='iminpain-numery.json'; a.click();
        }catch(e){}
      });
      document.getElementById('importNums').addEventListener('change', function(ev){
        var f=ev.target.files[0]; if(!f) return;
        var r=new FileReader(); r.onload=function(){
          try{
            var arr=JSON.parse(r.result); if(Array.isArray(arr)){ localStorage.setItem(NUM_KEY, JSON.stringify(arr)); loadNums(); }
          }catch(e){}
        }; r.readAsText(f);
      });
      loadNums();

      /* ====== KARTA MEDYCZNA ====== */
      var MC_KEY='iminpain_medcard_v1';
      var fields=['mc_name','mc_id','mc_blood','mc_ice','mc_dx','mc_rx','mc_all','mc_notes'];
      function saveMC(){ var data={}; fields.forEach(id=>data[id]=document.getElementById(id).value); localStorage.setItem(MC_KEY, JSON.stringify(data)); alert('Zapisano lokalnie.'); }
      function loadMC(){ try{ var data=JSON.parse(localStorage.getItem(MC_KEY)||'{}'); fields.forEach(id=>{ if(data[id]!=null) document.getElementById(id).value=data[id]; }); }catch(e){} }
      function clearMC(){ if(confirm('Wyczyścić kartę (tylko lokalnie)?')){ localStorage.removeItem(MC_KEY); fields.forEach(id=>document.getElementById(id).value=''); } }
      function exportMC(){ try{ var data=JSON.parse(localStorage.getItem(MC_KEY)||'{}'); var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='iminpain-karta-medyczna.json'; a.click(); }catch(e){} }
      function importMCFile(file){ var r=new FileReader(); r.onload=function(){ try{ var data=JSON.parse(r.result); if(data && typeof data==='object'){ localStorage.setItem(MC_KEY, JSON.stringify(data)); loadMC(); } }catch(e){} }; r.readAsText(file); }

      document.getElementById('saveMC').addEventListener('click', saveMC);
      document.getElementById('clearMC').addEventListener('click', clearMC);
      document.getElementById('printMC').addEventListener('click', function(){ window.print(); });
      document.getElementById('exportMC').addEventListener('click', exportMC);
      document.getElementById('importMC').addEventListener('change', function(ev){ var f=ev.target.files[0]; if(f) importMCFile(f); });
      loadMC();

      /* ====== PWA: rejestracja SW (opcjonalnie) ====== */
      if('serviceWorker' in navigator){
        window.addEventListener('load', function(){
          navigator.serviceWorker.register('service-worker.js').catch(function(){});
        });
      }
    })();
  </script>
</body>
</html>
