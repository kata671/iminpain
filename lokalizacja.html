<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Natychmiastowa pomoc ‚Äî lokalizacja</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Leaflet z CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="" crossorigin=""></script>
</head>
<body class="bg-med-light">
  <header class="site-header">
    <a class="back" href="javascript:history.back()">‚Üê Wr√≥ƒá</a>
    <h1>üöë Natychmiastowa pomoc</h1>
    <p class="subtitle">Twoja lokalizacja, najbli≈ºsze szpitale, przychodnie, lekarze i apteki</p>
  </header>

  <main class="container">
    <section class="card">
      <p><strong>Numery alarmowe:</strong> 112 (og√≥lny), 999 (pogotowie), 998 (stra≈º), 997 (policja).</p>
      <p>Je≈õli to nag≈Çe zagro≈ºenie ≈ºycia ‚Äî dzwo≈Ñ od razu.</p>
    </section>

    <div id="map" class="map"></div>

    <section class="card">
      <h2>Plac√≥wki w pobli≈ºu</h2>
      <div id="list"></div>
    </section>
  </main>

  <script>
    const map = L.map('map', { zoomControl: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    function renderList(items){
      const container = document.getElementById('list');
      if(!items.length){ container.innerHTML = "<p>Brak danych w pobli≈ºu.</p>"; return; }
      const groups = {hospital:[], clinic:[], doctors:[], pharmacy:[]};
      items.forEach(x=>{ if(groups[x.type]) groups[x.type].push(x); });
      const labels = {hospital:"Szpitale", clinic:"Przychodnie", doctors:"Lekarze", pharmacy:"Apteki"};
      container.innerHTML = Object.keys(groups).map(t=>{
        const arr = groups[t];
        if(!arr.length) return "";
        return `
          <h3>${labels[t]}</h3>
          <ul class="list">
            ${arr.map(i=>`<li><strong>${i.name||"(bez nazwy)"}</strong> ‚Äî ${i.distance.toFixed(0)} m</li>`).join("")}
          </ul>
        `;
      }).join("");
    }

    function distance(a,b){
      const R=6371000, toRad = d=>d*Math.PI/180;
      const dLat = toRad(b.lat-a.lat), dLon = toRad(b.lng-a.lng);
      const s = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(s));
    }

    function fetchOverpass(lat,lng){
      const query = `
        [out:json][timeout:25];
        (
          node["amenity"="hospital"](around:3000,${lat},${lng});
          node["amenity"="clinic"](around:3000,${lat},${lng});
          node["amenity"="doctors"](around:3000,${lat},${lng});
          node["amenity"="pharmacy"](around:3000,${lat},${lng});
        );
        out body; >; out skel qt;`;
      return fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query})
        .then(r=>r.json());
    }

    navigator.geolocation.getCurrentPosition(async pos=>{
      const center = {lat: pos.coords.latitude, lng: pos.coords.longitude};
      map.setView(center, 14);
      const userMarker = L.circleMarker(center,{radius:8}).addTo(map).bindPopup("Tu jeste≈õ");
      try{
        const data = await fetchOverpass(center.lat, center.lng);
        const items = (data.elements||[])
          .filter(el=>el.type==="node" && ["hospital","clinic","doctors","pharmacy"].includes(el.tags?.amenity))
          .map(el=>{
            const p = {lat: el.lat, lng: el.lon};
            const d = distance(center,p);
            const t = el.tags.amenity;
            const name = el.tags.name || el.tags.operator || "";
            return {type:t, name, p, distance:d};
          })
          .sort((a,b)=>a.distance-b.distance)
          .slice(0,60);

        items.forEach(i=>{
          L.marker(i.p).addTo(map).bindPopup(`<b>${i.name||"(bez nazwy)"}</b><br>${i.type}`);
        });
        renderList(items);
      }catch(e){
        renderList([]);
      }
    }, err=>{
      map.setView([52.1,19.1],6);
      document.getElementById('list').innerHTML = "<p>Brak zgody na lokalizacjƒô. W≈ÇƒÖcz dostƒôp do lokalizacji w przeglƒÖdarce.</p>";
    }, {enableHighAccuracy:true, timeout:10000});
  </script>
</body>
</html>
