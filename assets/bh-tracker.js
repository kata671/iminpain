(function(){
  try{
    if(!(window.BH&&BH.features&&BH.features.tracker)) return;
    const url=new URL(location.href);const czesc=(url.searchParams.get('czesc')||'').toLowerCase();const typ=(url.searchParams.get('typ')||'').toLowerCase();
    const KEY='BH_TRACKER_V1';
    const read=()=>JSON.parse(localStorage.getItem(KEY)||'[]');
    const write=(arr)=>localStorage.setItem(KEY,JSON.stringify(arr));
    const fab=document.createElement('div');fab.className='bh-fab';fab.title='Dziennik objawów';fab.innerHTML='✚';document.body.appendChild(fab);
    const modal=document.createElement('div');modal.className='bh-modal';modal.setAttribute('role','dialog');modal.setAttribute('aria-modal','true');
    modal.innerHTML=`<div class="bh-dialog"><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;"><h2>Dziennik objawów</h2><div class="bh-muted">${new Date().toLocaleString()}</div></div><div class="bh-grid" style="margin-bottom:10px;"><div><label>Obszar</label><input class="bh-input" id="bh-part" value="${czesc||''}" placeholder="np. kolano"></div><div><label>Nasilenie bólu (0–10)</label><input class="bh-input" id="bh-score" type="number" min="0" max="10" step="1" value="3"></div><div style="grid-column:1 / -1;"><label>Notatka</label><textarea class="bh-text" id="bh-note" rows="3" placeholder="np. ból przy schodzeniu, chłodzenie pomaga"></textarea></div></div><div class="bh-row" style="justify-content:flex-end; margin-bottom:10px;"><button class="bh-btn ghost" id="bh-export-csv">Eksport CSV</button><button class="bh-btn ghost" id="bh-export-pdf">Eksport PDF</button><button class="bh-btn" id="bh-save">Zapisz wpis</button></div><div><div class="bh-muted" style="margin:6px 0 6px;">Ostatnie wpisy</div><div class="bh-spark" id="bh-spark"></div><table class="bh-table" id="bh-table"><thead><tr><th>Data</th><th>Obszar</th><th>Skala</th><th>Notatka</th><th class="bh-right">Usuń</th></tr></thead><tbody></tbody></table></div></div>`;
    document.body.appendChild(modal);
    function render(){
      const data=read();const tb=modal.querySelector('#bh-table tbody');tb.innerHTML='';
      data.slice().reverse().forEach((row)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${new Date(row.ts).toLocaleString()}</td><td>${row.part||''}</td><td>${row.score}</td><td>${row.note||''}</td><td class="bh-right"><button class="bh-btn ghost" data-del="${row.id}">Usuń</button></td>`;tb.appendChild(tr);});
      const cnv=modal.querySelector('#bh-spark');const w=cnv.clientWidth,h=cnv.clientHeight;const c=document.createElement('canvas');c.width=w;c.height=h;cnv.innerHTML='';cnv.appendChild(c);const ctx=c.getContext('2d');const points=read().map(d=>({x:new Date(d.ts).getTime(),y:d.score}));
      if(points.length>=2){const xmin=Math.min(...points.map(p=>p.x)),xmax=Math.max(...points.map(p=>p.x)),ymin=0,ymax=10;const X=v=>(w-16)*(v-xmin)/Math.max(1,(xmax-xmin))+8;const Y=v=>h-((h-12)*(v-ymin)/(ymax-ymin))-6;ctx.lineWidth=2;ctx.strokeStyle='rgba(255,255,255,.85)';ctx.beginPath();points.sort((a,b)=>a.x-b.x).forEach((p,i)=>{if(i===0)ctx.moveTo(X(p.x),Y(p.y));else ctx.lineTo(X(p.x),Y(p.y));});ctx.stroke();ctx.fillStyle='rgba(113,209,255,1)';points.forEach(p=>{ctx.beginPath();ctx.arc(X(p.x),Y(p.y),3,0,Math.PI*2);ctx.fill();});}else{ctx.fillStyle='rgba(255,255,255,.7)';ctx.fillText('Brak danych — dodaj pierwszy wpis',10,h/2);}
    }
    fab.addEventListener('click',()=>{modal.setAttribute('open','');render();});
    modal.addEventListener('click',(e)=>{if(e.target===modal)modal.removeAttribute('open');});
    modal.querySelector('#bh-save').addEventListener('click',()=>{const row={id:Math.random().toString(36).slice(2),ts:Date.now(),part:(modal.querySelector('#bh-part').value.trim()||czesc||'nieokreślone'),score:Math.max(0,Math.min(10,parseInt(modal.querySelector('#bh-score').value||'0',10))),note:modal.querySelector('#bh-note').value.trim()};const data=read();data.push(row);write(data);render();});
    modal.querySelector('#bh-table').addEventListener('click',(e)=>{const id=e.target?.dataset?.del;if(!id)return;const data=read().filter(r=>r.id!==id);write(data);render();});
    modal.querySelector('#bh-export-csv').addEventListener('click',()=>{const data=read();const esc=(s)=>('"'+String(s).replace(/"/g,'""')+'"');const csv=['timestamp,datetime,part,score,note'].concat(data.map(d=>[d.ts,new Date(d.ts).toISOString(),esc(d.part||''),d.score,esc(d.note||'')].join(','))).join('\n');const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='bolihelp-dziennik.csv';a.click();URL.revokeObjectURL(a.href);});
    modal.querySelector('#bh-export-pdf').addEventListener('click',()=>{const data=read();const w=window.open('','_blank');w.document.write('<html><head><title>Raport objawów</title></head><body>');w.document.write('<h2>Raport objawów — Boli Help</h2>');w.document.write('<table border="1" cellspacing="0" cellpadding="6"><tr><th>Data</th><th>Obszar</th><th>Skala</th><th>Notatka</th></tr>');data.slice().reverse().forEach(d=>{w.document.write(`<tr><td>${new Date(d.ts).toLocaleString()}</td><td>${d.part||''}</td><td>${d.score}</td><td>${(d.note||'').replace(/</g,'&lt;')}</td></tr>`);});w.document.write('</table></body></html>');w.document.close();w.focus();w.print();});
  }catch(e){console.warn('BH tracker error',e)}
})();