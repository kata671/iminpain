<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Boli Help ‚Äî Szczeg√≥≈Çy</title>
  <meta name="theme-color" content="#0e1230" />
  <style>
    :root{
      --bg:#0e1230; --text:#eef2ff; --muted:#b8c2e0;
      --card: rgba(60,32,100,.30); --stroke: rgba(164,107,255,.18);
      --accent:#a46bff; --pink:#ff6ec7; --teal:#5eead4;
      --ok:#70e1b1; --warn:#ffd16c; --danger:#ff6b6b;
      --radius:16px; --gap:14px; --speed:.24s;
      --c-symptoms: rgba(94,234,212,.55);
      --c-causes:   rgba(164,107,255,.55);
      --c-firstaid: rgba(112,225,177,.55);
      --c-otc:      rgba(255,184,108,.65);
      --c-rx:       rgba(255,107,107,.70);
      --c-rehab:    rgba(94,234,212,.65);
      --c-myths:    rgba(164,107,255,.65);
      --c-faq:      rgba(94,234,212,.55);
      --c-dx:       rgba(164,107,255,.65);
      --c-docs:     rgba(94,234,212,.65);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body[data-page="szczegoly"]{margin:0; background:var(--bg); color:var(--text);
      font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .bg-anim{position:fixed; inset:0; z-index:-3; pointer-events:none;
      background:
        radial-gradient(42vw 36vh at 16% 12%, rgba(255,110,199,.26), transparent 60%),
        radial-gradient(36vw 30vh at 84% 10%, rgba(94,234,212,.22), transparent 60%),
        radial-gradient(40vw 44vh at 20% 88%, rgba(164,107,255,.16), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      filter: blur(10px) saturate(118%);
    }
    .grid-bg{position:fixed; inset:0; z-index:-2; pointer-events:none; opacity:.22;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='104' viewBox='0 0 120 104'%3E%3Cg fill='none' stroke='rgba(173,216,255,0.26)' stroke-width='1'%3E%3Cpolygon points='30,0 90,0 120,52 90,104 30,104 0,52'/%3E%3C/g%3E%3C/svg%3E");
      background-size:160px 138px; background-position:center;}
    #bh-particles{ position:fixed; inset:0; z-index:-1; opacity:.85; pointer-events:none }

    header.app{ max-width:1100px; margin:16px auto 0; padding:16px 16px 8px; }
    main{ max-width:1100px; margin:0 auto 72px; padding:0 16px 24px; }
    .bh-backbar{max-width:1100px; margin:8px auto 0; padding:0 16px;}
    #bhReturnTop{
      appearance:none; border:1px solid rgba(164,107,255,.28); background:rgba(60,32,100,.28);
      color:#eef2ff; font-weight:800; letter-spacing:.2px; padding:10px 14px; border-radius:12px; cursor:pointer;
      box-shadow:0 6px 16px rgba(8,10,22,.35), inset 0 0 0 1px rgba(164,107,255,.12), 0 0 8px rgba(164,107,255,.45);
      transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    #bhReturnTop:hover{ transform:translateY(-1px); border-color:rgba(164,107,255,.55); box-shadow:0 10px 20px rgba(8,10,22,.45), 0 0 14px rgba(164,107,255,.65), inset 0 0 0 1px rgba(164,107,255,.18) }
    #bhReturnTop:focus-visible{ outline:2px solid rgba(164,107,255,.75); outline-offset:2px }

    .hero{ background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--stroke); border-radius:var(--radius); padding:16px;
      backdrop-filter: blur(6px) saturate(120%); box-shadow: 0 18px 48px rgba(8,10,22,.55), 0 0 22px rgba(164,107,255,.18);}
    .hero-top{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .crumbs{font-weight:800; letter-spacing:.2px; color:#cfe2ff}
    .label{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      background: rgba(164,107,255,.18); border:1px solid var(--stroke); font-weight:800; letter-spacing:.3px; }
    .hero-note{ margin-top:10px; color:#b8c2e0; font-size:13px; }
    .legend{ color:#d6e4ff; font-weight:700; margin-top:6px; font-size:13px }

    .steps{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin:14px 0 0}
    .step{position:relative; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05); font-weight:900; letter-spacing:.2px; color:#dfe6ff; text-align:center}
    .step.active{border-color:rgba(94,234,212,.55); box-shadow:0 0 0 2px rgba(94,234,212,.35), 0 8px 18px rgba(8,10,22,.35)}

    .tabs{ display:flex; flex-wrap:wrap; gap:8px; margin:16px 0 8px; }
    .tab{ padding:9px 13px; border-radius:10px; font-weight:800; letter-spacing:.2px; cursor:pointer; user-select:none;
      background: transparent; border:1px solid rgba(255,255,255,.16); color:#e9efff;
      transition: box-shadow var(--speed), transform var(--speed), border-color var(--speed), background var(--speed);}
    .tab:hover{ transform: translateY(-1px); }
    .tab[aria-selected="true"]{ box-shadow:0 0 0 2px rgba(94,234,212,.35); border-color:rgba(94,234,212,.55) }

    .cards{ margin-top:8px }
    .card{ display:none; background: var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      padding:16px 16px 14px; backdrop-filter: blur(10px) saturate(125%); box-shadow: 0 14px 34px rgba(8,10,22,.42);
      transition: transform var(--speed), box-shadow var(--speed), border-color var(--speed); color:var(--text); }
    .card[aria-hidden="false"]{ display:block; animation:fadeIn .28s ease both }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none} }
    .card h3{ position:relative; margin:.15rem 0 .85rem; font-size:16px; font-weight:900; letter-spacing:.3px; color:#e6f0ff }
    .card h3::after{ content:""; display:block; height:1px; margin-top:.55rem;
      background:linear-gradient(90deg, rgba(207,226,255,.55), rgba(255,255,255,.08) 45%, transparent); }

    ul.clean{ list-style:none; margin:0; padding:0 }
    ul.clean li{ position:relative; padding:10px 12px 10px 36px; border-radius:10px; margin-bottom:7px;
      border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); color:#f6f8ff; }
    .cb{ position:absolute; left:10px; top:50%; transform:translateY(-50%); width:18px; height:18px; border-radius:4px;
      border:1px solid rgba(255,255,255,.35); background:rgba(255,255,255,.05); display:inline-block }
    .cb.checked{ background:#fff; box-shadow:0 0 0 2px rgba(164,107,255,.25) inset }
    .li-checked{ outline:1px solid rgba(164,107,255,.45); background: rgba(164,107,255,.10) }

    .risk-mini{ display:flex; align-items:center; gap:10px; margin:.15rem 0 .35rem }
    .risk-mini small{ color:#d6e4ff; font-weight:800 }
    .riskbar{ position:relative; width:200px; height:12px; border-radius:999px; overflow:hidden;
      outline:1px solid rgba(255,255,255,.16);
      background: linear-gradient(90deg, var(--ok), var(--warn), var(--danger)); }
    .cursor{ position:absolute; top:50%; transform:translate(-50%,-50%); width:16px; height:16px; border-radius:50%; background:#fff }

    .strip{ background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.16); padding:.7rem 1rem; border-radius:.8rem; margin:.6rem 0; }
    .strip--warn{ background: linear-gradient(180deg, rgba(255,184,108,.18), rgba(255,255,255,.04)); border-color: rgba(255,184,108,.55); }
    .cta{ display:inline-block; padding:8px 12px; border-radius:10px; font-weight:900; background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.18); text-decoration:none; color:var(--text); }

    .dx-hint{ display:none; margin-top:10px; border-radius:10px; padding:10px 12px;
      background:rgba(164,107,255,.12); border:1px solid rgba(164,107,255,.35); color:#e9e6ff; }
    .dx-hint.show{ display:block }
    .dx-hint button{ margin-left:8px; padding:8px 10px; border-radius:10px; font-weight:700; background:#a46bff; color:#fff; border:none; cursor:pointer }

    /* Telefony */
    @media (max-width:768px){
      .steps{grid-template-columns:repeat(2,1fr);}
      .hero{ padding:14px; }
      .hero-top{ flex-direction:column; align-items:flex-start; }
      .label{ margin-top:8px; }
      .dx-hint{ margin-top:14px; }
      .tabs{ gap:6px; margin:14px 0 6px; }
      .tab{ padding:8px 10px; border-radius:8px; font-size:13px; }
    }
  </style>

  </head>
<body data-page="szczegoly">
  <div class="bg-anim"></div>
  <div class="grid-bg"></div>
  <canvas id="bh-particles"></canvas>

  <div class="bh-backbar">
    <button id="bhReturnTop">‚Üê Powr√≥t do mapy</button>
  </div>

  <header class="app">
    <div class="hero">
      <div class="hero-top">
        <div class="crumbs">
          <span id="crumb-typ">Kobieta</span> / <span id="crumb-label">Szczeg√≥≈Çy</span>
        </div>
        <div class="label" id="label-text">
          <b>G≈Çowa</b> ‚Ä¢ Kobieta
        </div>
      </div>
      <div class="hero-note">Wybierz objawy, aby oszacowaƒá ryzyko i dopasowaƒá zalecenia. Pamiƒôtaj, to tylko wsparcie informacyjne, nie diagnoza.</div>
      <div class="legend">PAMIƒòTAJ! Wysokie ryzyko wymaga kontaktu ze specjalistƒÖ. Niskie/≈örednie ‚Äî POZ.</div>
    </div>
  </header>

  <main>
    <div class="tabs" role="tablist">
      <div class="tab" role="tab" data-target="#s-objawy" aria-controls="s-objawy" data-variant="symptoms" aria-selected="true">Objawy</div>
      <div class="tab" role="tab" data-target="#s-przyczyny" aria-controls="s-przyczyny" data-variant="causes">Przyczyny</div>
      <div class="tab" role="tab" data-target="#s-pierwsza-pomoc" aria-controls="s-pierwsza-pomoc" data-variant="firstaid">Pierwsza Pomoc</div>
      <div class="tab" role="tab" data-target="#s-leki" aria-controls="s-leki" data-variant="otc">Leki</div>
      <div class="tab" role="tab" data-target="#s-diagnostyka" aria-controls="s-diagnostyka" data-variant="dx">Diagnostyka</div>
      <div class="tab" role="tab" data-target="#s-mity" aria-controls="s-mity" data-variant="myths">Mity & FAQ</div>
    </div>

    <div class="cards">
      <div class="card" id="s-objawy" role="tabpanel" aria-hidden="false">
        <h3 id="h-obj">Objawy ‚Äì Wybierz odczuwane:</h3>
        <ul id="symp-common" class="clean"></ul>

        <div class="strip strip--warn" id="urgent-strip">üö® Objawy wskazujƒÖce na konieczno≈õƒá szybkiej interwencji lekarskiej lub SOR. Zadzwo≈Ñ na 112. <a class="cta" id="cta-112" href="tel:112" aria-label="Zadzwo≈Ñ 112">Zadzwo≈Ñ 112</a></div>
        <h3 class="subhead" style="margin-top:1.5rem">Czerwone Flagi (Urgent):</h3>
        <ul id="urgent" class="clean"></ul>

        <div class="risk-mini">
          <small>Szacowane Ryzyko:</small>
          <div class="riskbar">
            <span class="cursor" id="risk-cursor-card" style="left:20%"></span>
          </div>
        </div>
        <div class="dx-hint" id="dx-hint">
          <span>Na podstawie wybranych objaw√≥w i szacowanego ryzyka...</span>
          <button id="bhDxSuggest">Poka≈º sugerowanƒÖ jednostkƒô</button>
        </div>
      </div>

      <div class="card" id="s-przyczyny" role="tabpanel" aria-hidden="true">
        <h3 id="h-cause">Mo≈ºliwe przyczyny:</h3>
        <ul id="causes" class="clean"></ul>
      </div>

      <div class="card" id="s-pierwsza-pomoc" role="tabpanel" aria-hidden="true">
        <h3 id="h-aid">Zalecenia / Pierwsza Pomoc:</h3>
        <ul id="firstaid" class="clean"></ul>
        <h3 id="h-rehab" style="margin-top:1.5rem">Rehabilitacja/D≈Çugofalowo:</h3>
        <ul id="rehab" class="clean"></ul>
      </div>

      <div class="card" id="s-leki" role="tabpanel" aria-hidden="true">
        <h3 id="h-otc">Leki (bez recepty):</h3>
        <ul id="meds-otc" class="clean"></ul>
        <h3 id="h-rx" style="margin-top:1.5rem">Leki (na receptƒô)</h3>
        <ul id="meds-rx" class="clean"></ul>
      </div>

      <div class="card" id="s-diagnostyka" role="tabpanel" aria-hidden="true">
        <h3 id="h-dx">Diagnostyka & Wizyta u Lekarza:</h3>
        <ul id="dx-list" class="clean"></ul>
        <h3 id="h-docs" style="margin-top:1.5rem">Specjali≈õci / Lekarze:</h3>
        <ul id="docs-list" class="clean"></ul>
      </div>

      <div class="card" id="s-mity" role="tabpanel" aria-hidden="true">
        <h3 id="h-mity">Mity i Fakty:</h3>
        <ul id="myths" class="clean"></ul>
        <h3 id="h-faq" style="margin-top:1.5rem">Najczƒô≈õciej Zadawane Pytania (FAQ):</h3>
        <ul id="faq" class="clean"></ul>
      </div>
    </div>
  </main>

  <script src="assets/i18n.js?v=2"></script>
  <script src="assets/content.js?v=4"></script> <script>
    // === FIX 1: Wstrzykniƒôcie brakujƒÖcych danych CONTENT_PL i CONTENT_EN ===
    // Aby zapewniƒá, ≈ºe skrypt znajdzie tre≈õƒá dla nowych element√≥w (uszy, kolano, ospa, pochwa)
    // i nie u≈ºyje awaryjnie 'glowa', dodajemy puste struktury danych, kt√≥re bƒôdƒÖ u≈ºyte
    // zamiast "glowa" je≈õli u≈ºytkownik kliknie na te nowe elementy.
    
    // Zak≈Çadamy, ≈ºe CONTENT_PL i CONTENT_EN sƒÖ zdefiniowane przez content.js
    if(typeof CONTENT_PL !== 'undefined'){
      Object.assign(CONTENT_PL, {
        uszy: { label: "Uszy", symptoms: ["B√≥l ucha", "Wysoka gorƒÖczka"], causes: ["Infekcja bakteryjna/wirusowa"], firstaid: ["Paracetamol/Ibuprofen"], otc: ["Krople do uszu"], rx: ["Antybiotyki"], rehab: [], myths: [], faq: [], dx: [] },
        kolano: { label: "Kolano", symptoms: ["Obrzƒôk kolana", "B√≥l przy ruchu/obciƒÖ≈ºeniu"], causes: ["Uraz wiƒôzad≈Ça", "Zapalenie stawu"], firstaid: ["Ok≈Çad z lodu (RICE)", "OdciƒÖ≈ºenie"], otc: ["Ma≈õci/≈ºele przeciwb√≥lowe"], rx: ["NLPZ doustne"], rehab: ["Fizjoterapia"], myths: [], faq: [], dx: [] },
        ospa: { label: "Ospa Wietrzna", symptoms: ["GorƒÖczka", "SwƒôdzƒÖce pƒôcherzyki na ca≈Çym ciele"], causes: ["Wirus VZV"], firstaid: ["Nawodnienie", "Leki przeciwgorƒÖczkowe (NIE ibuprofen)"], otc: ["Leki przeciwhistaminowe"], rx: [], rehab: [], myths: [], faq: [], dx: [] },
        pochwa: { label: "Pochwa", symptoms: ["≈öwiƒÖd, pieczenie", "Nieprawid≈Çowa wydzielina"], causes: ["Grzybica", "Waginoza bakteryjna"], firstaid: ["W≈Ça≈õciwa higiena"], otc: ["Globulki dopochwowe bez recepty"], rx: ["Antybiotyki/Leki przeciwgrzybicze na receptƒô"], rehab: [], myths: [], faq: [], dx: [] }
      });
    }

    if(typeof CONTENT_EN !== 'undefined'){
      Object.assign(CONTENT_EN, {
        uszy: { label: "Ears", symptoms: ["Ear ache", "High fever"], causes: ["Bacterial/Viral infection"], firstaid: ["Paracetamol/Ibuprofen"], otc: ["Ear drops"], rx: ["Antibiotics"], rehab: [], myths: [], faq: [], dx: [] },
        kolano: { label: "Knee", symptoms: ["Knee swelling", "Pain on movement/weight-bearing"], causes: ["Ligament injury", "Arthritis"], firstaid: ["Ice pack (RICE)", "Rest"], otc: ["Topical pain relief"], rx: ["Oral NSAIDs"], rehab: ["Physiotherapy"], myths: [], faq: [], dx: [] },
        ospa: { label: "Chickenpox", symptoms: ["Fever", "Itchy blisters all over the body"], causes: ["VZV Virus"], firstaid: ["Hydration", "Fever reducers (NOT Ibuprofen)"], otc: ["Antihistamines"], rx: [], rehab: [], myths: [], faq: [], dx: [] },
        pochwa: { label: "Vagina", symptoms: ["Itching, burning", "Abnormal discharge"], causes: ["Yeast Infection", "Bacterial Vaginosis"], firstaid: ["Proper hygiene"], otc: ["Over-the-counter suppositories"], rx: ["Prescription Antibiotics/Antifungals"], rehab: [], myths: [], faq: [], dx: [] }
      });
    }
    // ===================================================================


    const qs=new URLSearchParams(location.search);
    const RAW_TYP=(qs.get('typ')||'kobieta').toLowerCase();
    const RAW_CZESC=(qs.get('czesc')||'glowa').toLowerCase();
    const RAW_LABEL=(qs.get('label')||RAW_CZESC).toString();

    const ALIAS={'oko':'glowa','klatka-piersiowa':'klatka','zoladek':'brzuch'};
    const TYP=RAW_TYP, CZESC=(ALIAS[RAW_CZESC]||RAW_CZESC), LABEL=RAW_LABEL;

    /* --- zastosowanie i18n do UI (tylko nag≈Ç√≥wki/teksty, nie listy) --- */
    (function applyI18N(){
      const d=I18N[L()];

      // breadcrumb
      const typMap = L()==='en' ? {kobieta:'Woman',mezczyzna:'Man',dziecko:'Child'} : {kobieta:'Kobieta',mezczyzna:'Mƒô≈ºczyzna',dziecko:'Dziecko'};
      document.getElementById('crumb-typ').textContent=(typMap[TYP]||TYP);
      document.getElementById('crumb-label').textContent=d.crumbs_details;

      // hero
      const note=document.querySelector('.hero-note'); if(note) note.innerHTML=d.hero_note;
      const leg=document.querySelector('.legend'); if(leg) leg.innerHTML=d.legend;

      // tabs
      const tab=(v,txt)=>{ const el=document.querySelector(`.tab[data-variant="${v}"]`); if(el) el.textContent=txt; };
      Object.entries(d.tabs).forEach(([k,v])=>tab(k,v));

      // headings
      const setTxt=(sel,txt)=>{ const el=document.querySelector(sel); if(el) el.textContent=txt; };
      setTxt('#h-obj', d.symptoms_head);
      setTxt('.subhead', d.urgent_head);
      setTxt('#h-cause', d.tabs.causes);
      setTxt('#h-aid', d.tabs.firstaid);
      setTxt('#h-otc', d.tabs.otc);
      setTxt('#h-rx', d.tabs.rx);
      setTxt('#h-rehab', d.tabs.rehab);
      setTxt('#h-mity', d.tabs.myths);
      setTxt('#h-faq', d.tabs.faq);
      setTxt('#h-dx', d.tabs.dx);
      setTxt('#h-docs', d.tabs.docs);

      // labels
      const lab=document.querySelector('.langpick label'); if(lab) lab.textContent=d.lang_label;

      // back + urgent strip + risk caption
      const back=document.getElementById('bhReturnTop'); if(back) back.textContent=d.back;
      const strip=document.getElementById('urgent-strip'); if(strip) strip.innerHTML=`${d.urgent_strip} <a class="cta" id="cta-112" href="tel:112" aria-label="${d.call_112}">${d.call_112}</a>`;
      const riskWrap=document.querySelector('.risk-mini small');
      if(riskWrap){
        const lbl=document.getElementById('risk-label')||document.createElement('span');
        lbl.id='risk-label';
        lbl.textContent=d.risk_low;
        riskWrap.textContent=d.risk+' ';
        riskWrap.appendChild(lbl);
      }
    })();


    /* --- wyb√≥r contentu wg jƒôzyka i czƒô≈õci cia≈Ça --- */
    const CONTENT=(L()==='en')?CONTENT_EN:CONTENT_PL;
    const entry = CONTENT[CZESC] || CONTENT.glowa; // Dzia≈Ça poprawnie, bo CONTENT ma ju≈º dodane brakujƒÖce klucze.
    document.getElementById('label-text').innerHTML='<b>'+(entry.label||LABEL)+'</b> ‚Ä¢ '+TYP;


    /* --- helpers / scoring --- */
    const isChild=(TYP==='dziecko');
    const allowItem=(it)=> typeof it==='string' ? true : (isChild ? (it.audience!=='adult') : (it.audience!=='child'));
    const textOf =(it)=> typeof it==='string' ? it : it.t;

    const HIGH_PL=["duszno≈õƒá","sinica","utrata przytomno≈õci","krwawienie","twardy brzuch","najgorszy b√≥l"];
    const MID_PL =["gorƒÖczka","sztywno≈õƒá karku","silny b√≥l"];
    const HIGH_EN=["dyspnea","cyanosis","loss of consciousness","bleeding","rigid abdomen","thunderclap"];
    const MID_EN =["fever","neck stiffness","severe pain"];
    const phrases=()=> L()==='en'?{H:HIGH_EN,M:MID_EN}:{H:HIGH_PL,M:MID_PL};

    function weightFor(text,bucket){
      const s=(text||'').toLowerCase();
      if(bucket==='urgent') return 35;
      const P=phrases();
      if(P.H.some(k=>s.includes(k))) return 20;
      if(P.M.some(k=>s.includes(k))) return 10;
      if(bucket==='symptoms') return 6;
      return 0;
    }

    /* --- renderery list --- */
    let selectedWeights=0, selectedCount=0;

    function renderListInteractive(id,arr,bucket){
      const ul=document.getElementById(id);
      ul.innerHTML='';
      (arr||[]).filter(allowItem).map(textOf).forEach(txt=>{
        const li=document.createElement('li');
        const cb=document.createElement('span');
        cb.className='cb'; cb.setAttribute('role','checkbox'); cb.setAttribute('aria-checked','false');
        const w=weightFor(txt,bucket);
        li.dataset.weight=w;
        li.appendChild(cb);
        li.appendChild(document.createTextNode(txt));

        function toggle(){
          const on=cb.classList.toggle('checked');
          li.classList.toggle('li-checked',on);
          cb.setAttribute('aria-checked',on?'true':'false');
          selectedWeights += on? +w : -w;
          selectedCount += on? 1 : -1;
          updateRisk();
          document.dispatchEvent(new CustomEvent('bh:symptoms-changed'));
        }

        li.addEventListener('click',e=>{
          if(e.target!==cb) toggle();
        });
        cb.addEventListener('click',e=>{
          e.stopPropagation();
          toggle();
        });
        ul.appendChild(li);
      });
    }

    function renderListPlain(id,arr){
      const ul=document.getElementById(id);
      ul.innerHTML='';
      (arr||[]).filter(allowItem).map(textOf).forEach(txt=>{
        const li=document.createElement('li');
        const cb=document.createElement('span');
        cb.className='cb'; cb.style.visibility='hidden';
        li.appendChild(cb);
        li.appendChild(document.createTextNode(txt));
        ul.appendChild(li);
      });
    }

    function fillPairs(id,arr){
      const ul=document.getElementById(id);
      ul.innerHTML='';
      (arr||[]).forEach(x=>{
        const li=document.createElement('li');
        const cb=document.createElement('span');
        cb.className='cb'; cb.style.visibility='hidden';
        li.appendChild(cb);
        const isEn=L()==='en';
        const m=document.createElement('div'); m.innerHTML='<strong>'+(isEn?'Myth:':'Mit:')+'</strong> '+(x.m||'‚Äî');
        const f=document.createElement('div'); f.innerHTML='<strong>'+(isEn?'Fact:':'Fakt:')+'</strong> '+(x.f||'‚Äî');
        li.appendChild(m); li.appendChild(f);
        ul.appendChild(li);
      });
    }

    function fillFAQ(id,arr){
      const ul=document.getElementById(id);
      ul.innerHTML='';
      (arr||[]).forEach(x=>{
        const li=document.createElement('li');
        const cb=document.createElement('span');
        cb.className='cb'; cb.style.visibility='hidden';
        li.appendChild(cb);
        li.innerHTML+='<strong>'+(x.q|| (L()==='en'?'Question':'Pytanie'))+'</strong><div style="margin-top:4px;color:#b8c2e0">'+(x.a|| (L()==='en'?'Answer':'Odpowied≈∫'))+'</div>';
        ul.appendChild(li);
      });
    }

    renderListInteractive('symp-common',entry.symptoms,'symptoms');
    renderListInteractive('urgent',entry.urgent||[],'urgent');
    renderListPlain('causes',entry.causes||[]);
    renderListPlain('firstaid',entry.firstaid||[]);
    renderListPlain('meds-otc',entry.otc||[]);
    renderListPlain('meds-rx',entry.rx||[]);
    renderListPlain('rehab',entry.rehab||[]);
    fillPairs('myths',entry.myths||[]);
    fillFAQ('faq',entry.faq||[]);

    function updateRisk(){
      const d=I18N[L()];
      const c=document.getElementById('risk-cursor-card');
      const lbl=document.getElementById('risk-label');
      const val=Math.max(0,Math.min(100,selectedWeights));
      if(c) c.style.left=val+'%';
      if(lbl){
        let t=d.risk_low;
        if(val>=70) t=d.risk_high;
        else if(val>=40) t=d.risk_mid;
        lbl.textContent=t;
      }
      const hint=document.getElementById('dx-hint');
      hint.classList.toggle('show',selectedCount>0);
    }
    updateRisk();

    /* --- tabs --- */
    const tabs=[...document.querySelectorAll('.tab')];
    const panels=[...document.querySelectorAll('.card[role="tabpanel"]')];

    function showPanel(sel){
      panels.forEach(p=>p.setAttribute('aria-hidden',('#'+p.id)===sel?'false':'true'));
      tabs.forEach(t=>t.setAttribute('aria-selected', t.getAttribute('data-target')===sel?'true':'false'));
      document.querySelector(sel)?.scrollIntoView({behavior:'smooth',block:'start'});
    }

    tabs.forEach(t=>t.addEventListener('click',()=>showPanel(t.getAttribute('data-target'))));


    /* --- Dx / Doctors --- */
    function gather(){
      const from=(id)=>[...document.querySelectorAll('#'+id+' li.li-checked')].map(li=>li.textContent.toLowerCase());
      return {symp:from('symp-common'),urgent:from('urgent')};
    }

    const DX_RULES={
      glowa:[
        {pl:{name:"B√≥l napiƒôciowy",advice:"POZ / higiena snu"},en:{name:"Tension-type headache",advice:"GP / sleep hygiene"},keys:["ucisk","napiƒôcie","bilateral"],badge:"poz"},
        {pl:{name:"Migrena",advice:"POZ; przy nawrotach neurolog"},en:{name:"Migraine",advice:"GP; neurologist if recurrent"},keys:["pulsujƒÖcy","≈õwiat≈Ço"],badge:"poz"},
        {pl:{name:"Zapalenie opon ‚Äî pilnie",advice:"SOR/112"},en:{name:"Meningitis ‚Äî urgent",advice:"ER/112"},keys:["sztywno≈õƒá karku","gorƒÖczka","wymioty","≈õwiat≈Çowstrƒôt"],badge:"sor"}
      ],
      // --- FIX 2: Dodanie regu≈Ç diagnostycznych dla nowych czƒô≈õci cia≈Ça ---
      uszy:[
          {pl:{name:"Zapalenie ucha ≈õrodkowego",advice:"Lekarz rodzinny/pediatra"},en:{name:"Middle ear infection",advice:"GP/Pediatrician"},keys:["b√≥l ucha","gorƒÖczka","wyciek"],badge:"poz"},
          {pl:{name:"Ostre zapalenie wyrostka sutkowatego ‚Äî pilnie!",advice:"SOR/112"},en:{name:"Acute mastoiditis ‚Äî urgent!",advice:"ER/112"},keys:["b√≥l","obrzƒôk za uchem"],badge:"sor"}
      ],
      kolano:[
          {pl:{name:"Uraz wiƒôzad≈Ça (ACL/MCL)",advice:"Ortopeda (badanie i USG)"},en:{name:"Ligament injury (ACL/MCL)",advice:"Orthopedist (exam and ultrasound)"},keys:["niestabilno≈õƒá","trzask","blokowanie"],badge:"spec"},
          {pl:{name:"Zapalenie stawu/Kaletki",advice:"Lekarz rodzinny/Reumatolog"},en:{name:"Arthritis/Bursitis",advice:"GP/Rheumatologist"},keys:["ciep≈Ço","sztywno≈õƒá","opuchlizna"],badge:"poz"}
      ],
      ospa:[
          {pl:{name:"Ospa wietrzna (dzieci)",advice:"Pediatra; izolacja"},en:{name:"Chickenpox (children)",advice:"Pediatrician; isolation"},keys:["pƒôcherzyki","≈õwiƒÖd"],badge:"poz"},
          {pl:{name:"P√≥≈Çpasiec (doro≈õli)",advice:"Lekarz rodzinny (pilna diagnoza)"},en:{name:"Shingles (adults)",advice:"GP (urgent diagnosis)"},keys:["b√≥l","jednostronne pƒôcherze"],badge:"poz"}
      ],
      pochwa:[
          {pl:{name:"Grzybica pochwy",advice:"Ginekolog / OTC"},en:{name:"Yeast Infection",advice:"Gynecologist / OTC"},keys:["≈õwiƒÖd","serowata wydzielina"],badge:"poz"},
          {pl:{name:"Infekcja bakteryjna (BV)",advice:"Ginekolog"},en:{name:"Bacterial Vaginosis (BV)",advice:"Gynecologist"},keys:["rybi zapach","szare up≈Çawy"],badge:"poz"}
      ],
      // ------------------------------------------------------------------

      //... (inne zasady)
    };

    function matchDx(symptomList,urgentList){
      const rules=DX_RULES[CZESC]||[];
      const isEn=L()==='en';
      const D=L()==='en'?'en':'pl';
      const isUrgent=urgentList.length>0;

      for(const rule of rules){
        const keys=rule.keys||[];
        const match=keys.filter(k=>symptomList.includes(k.toLowerCase()));
        if(match.length>=rule.keys.length/2){
          if(isUrgent && rule.badge!=='sor' && rule.badge!=='pilne') continue; // Ignoruj niskie ryzyko je≈õli sƒÖ urgent
          return {
            name: rule[D].name||'Nieznane schorzenie',
            advice: rule[D].advice||(isEn?'Consult a specialist':'Skonsultuj siƒô ze specjalistƒÖ'),
            badge: rule.badge||'poz',
            matchCount: match.length,
            totalKeys: keys.length
          };
        }
      }
      return null;
    }

    const bhDxSuggest=document.getElementById('bhDxSuggest');
    bhDxSuggest.addEventListener('click', ()=>{
      const lists=gather();
      const result=matchDx(lists.symp,lists.urgent);
      const isEn=L()==='en';
      const d=I18N[L()];
      const dxWrap=document.getElementById('dx-list');
      const docsWrap=document.getElementById('docs-list');

      // Wyczy≈õƒá
      dxWrap.innerHTML=''; docsWrap.innerHTML='';

      if(result){
        const liDx=document.createElement('li');
        liDx.innerHTML=`<strong>${result.name}</strong><br><small style="color:#b8c2e0">Wg. algorytmu: ${result.matchCount}/${result.totalKeys} objaw√≥w pasuje.</small>`;
        dxWrap.appendChild(liDx);

        const liAdvice=document.createElement('li');
        liAdvice.innerHTML=`<strong>${result.advice}</strong>`;
        docsWrap.appendChild(liAdvice);
      }else{
        const liDef=document.createElement('li');
        liDef.textContent=isEn?'No specific condition matched.':'Nie dopasowano konkretnego schorzenia.';
        dxWrap.appendChild(liDef);

        const liAdviceDef=document.createElement('li');
        liAdviceDef.textContent=isEn?'Consult your GP for assessment.':'Skonsultuj siƒô z lekarzem rodzinnym w celu oceny.';
        docsWrap.appendChild(liAdviceDef);
      }
      showPanel('#s-diagnostyka');
    });

    document.getElementById('bhReturnTop').addEventListener('click',()=>window.location.href='/');
    document.getElementById('cta-112')?.addEventListener('click',()=>setTimeout(()=>window.location.href='tel:112',100)); // Ma≈Çy delay dla UX

    /* --- Finalne czyszczenie i ustawienia (na wszelki wypadek) --- */
    (function finalClean(){
      document.body.setAttribute('data-lang', L());
      if(L()==='en'){
        document.getElementById('cta-112').textContent='Call 112';
        document.getElementById('bhDxSuggest').textContent='Show suggested diagnosis';
      }
    })();
  </script>
</body>
</html>
