<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BÃ³l zÄ™ba 24H â€” ULTRA</title>
  <meta name="theme-color" content="#151c33" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

  <!-- opening_hours (otwarte teraz) -->
  <script src="https://unpkg.com/opening_hours@4.20.0/opening_hours.js"></script>

  <style>
    :root{
      --bg:#151c33; --panel:#162142; --panel2:#141e3a;
      --txt:#e9f1ff; --muted:#b6c7e6; --accent:#8b7bff; --ok:#2ce39b; --warn:#ffb963; --bad:#ff6b6b;
      --br:16px; --ring:0 0 0 3px rgba(139,123,255,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:
      radial-gradient(900px 500px at 85% -10%, rgba(139,123,255,.14), transparent),
      radial-gradient(700px 400px at 10% -20%, rgba(46,196,255,.10), transparent),
      var(--bg);
      color:var(--txt);
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:inherit;text-decoration:none}

    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(21,28,51,.95), rgba(21,28,51,.6));
      border-bottom:1px solid rgba(139,123,255,.25);backdrop-filter:saturate(120%) blur(8px)}
    .row{max-width:1280px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .title{font-weight:900;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--txt);border-radius:12px;
      padding:9px 12px;font-weight:800;cursor:pointer;display:inline-flex;gap:8px;align-items:center}
    .btn:hover{box-shadow:var(--ring); transform:translateY(-1px)}
    .btn.pri{border-color:rgba(139,123,255,.5)}

    .grid{max-width:1280px;margin:14px auto;padding:0 14px;display:grid;grid-template-columns:1.25fr .75fr;gap:14px}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--panel);border:1px solid rgba(139,123,255,.25);border-radius:var(--br);overflow:hidden}
    .head{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(139,123,255,.25)}

    /* TRIAGE */
    .triage{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;padding:12px;border-bottom:1px dashed rgba(139,123,255,.25)}
    .group{display:flex;flex-direction:column;gap:6px}
    .seg{display:flex;flex-wrap:wrap;gap:6px}
    .seg .seg-btn{padding:8px 10px;border:1px solid rgba(255,255,255,.18);border-radius:10px;background:rgba(255,255,255,.06);cursor:pointer;font-weight:800}
    .seg .seg-btn.active{box-shadow:var(--ring)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.2);font-size:12px}
    .badge.red{border-color:rgba(255,107,107,.6)} .badge.amber{border-color:rgba(255,185,99,.7)} .badge.green{border-color:rgba(44,227,155,.7)}
    .muted{color:var(--muted);font-size:14px;margin-top:4px}

    /* Controls */
    .controls{display:flex;flex-wrap:wrap;gap:10px;padding:10px 12px;border-bottom:1px dashed rgba(139,123,255,.25)}
    .range{display:flex;align-items:center;gap:8px}
    .range input{width:170px}

    /* Map + list */
    #map{height:66vh;min-height:420px}
    .legend{display:flex;gap:10px;align-items:center;padding:8px 12px;border-top:1px solid rgba(139,123,255,.25);background:var(--panel2)}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot24{background:#2ce39b}.dotOpen{background:#73d2ff}.dotElse{background:#b9a6ff}

    .side{display:flex;flex-direction:column;height:100%}
    .list{padding:8px;overflow:auto;min-height:240px;max-height:calc(66vh - 90px)}
    .dent{border:1px solid rgba(139,123,255,.25);border-radius:12px;padding:8px;margin:8px 0;background:rgba(255,255,255,.04)}
    .dent .name{font-weight:900}
    .dent .meta{opacity:.9}
    .tag{display:inline-block;margin-right:6px;margin-top:4px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.2);font-size:12px}
    .tag.open{border-color:rgba(44,227,155,.7)} .tag.closed{border-color:rgba(255,107,107,.7)} .tag.hi{border-color:rgba(44,227,155,.7);box-shadow:inset 0 0 0 1px rgba(44,227,155,.35)}
    .empty{padding:8px;color:var(--muted)}

    /* Legend toggles */
    .legend{flex-wrap:wrap; gap:12px}
    .lg-toggle{display:inline-flex;align-items:center;gap:8px;cursor:pointer;
      user-select:none;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.2);}
    .lg-toggle input{accent-color:#2ce39b; margin-right:2px}

    /* ===== Mobile overflow fix (wrap buttons, no cut) ===== */
    @media (max-width: 480px){
      .row{max-width:none !important; padding:8px 10px}
      .grid{max-width:none !important}
      .head > .row:last-child{flex-wrap:wrap}
      .head > .row:last-child .btn{flex:1 1 calc(50% - 6px)}
      .triage{grid-template-columns:1fr 1fr}
      .seg .seg-btn{padding:6px 8px;font-size:13px}
      .badge{font-size:12px;padding:5px 9px}
      .btn{padding:8px 10px;font-size:14px}
      #map{height:58vh; min-height:320px}
    }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div class="title">ğŸ¦· BÃ³l zÄ™ba 24H â€” ULTRA</div>
      <div class="row" style="gap:8px">
        <a class="btn" href="index.html">â† WrÃ³Ä‡</a>
      </div>
    </div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="head">
        <div style="font-weight:800">Twoja okolica</div>
        <div class="row" style="gap:8px">
          <button class="btn pri" id="btn-geoloc">ğŸ“ Lokalizacja</button>
          <button class="btn" id="btn-search-viewport">ğŸ”„ Szukaj w tym widoku</button>
          <a class="btn" id="gm-24" href="#" target="_blank" rel="noopener">ğŸ—ºï¸ Google 24h</a>
          <a class="btn" id="gm-all" href="#" target="_blank" rel="noopener">ğŸ—ºï¸ Google wszyscy</a>
        </div>
      </div>

      <div class="triage">
        <div class="group">
          <label>NatÄ™Å¼enie bÃ³lu</label>
          <div class="seg" id="pain-seg"></div>
        </div>
        <div class="group">
          <label>ObrzÄ™k / gorÄ…czka</label>
          <div class="seg" id="swelling-seg">
            <button class="seg-btn" data-val="no">Brak</button>
            <button class="seg-btn" data-val="mild">Åagodny</button>
            <button class="seg-btn" data-val="high">Silny / gorÄ…czka</button>
          </div>
        </div>
        <div class="group">
          <label>Uraz / po zabiegu</label>
          <div class="seg" id="trauma-seg">
            <button class="seg-btn" data-val="no">Nie</button>
            <button class="seg-btn" data-val="recent">Ost. 48h</button>
            <button class="seg-btn" data-val="bleeding">Krwawienie / zÅ‚amanie</button>
          </div>
        </div>
        <div class="group">
          <label>Wynik</label>
          <div id="t-badge" class="badge amber">DziÅ›</div>
        </div>
      </div>
      <div class="muted" id="t-out"></div>

      <div class="controls">
        <div class="range">PromieÅ„: <input id="radius" type="range" min="2" max="25" step="1" value="6"> <b id="radiusVal">6 km</b></div>
        <label><input type="checkbox" id="f-24"> tylko 24/7</label>
        <label><input type="checkbox" id="f-open"> otwarte teraz</label>
        <label><input type="checkbox" id="f-nfz"> NFZ</label>
        <label><input type="checkbox" id="f-wheel"> â™¿</label>
      </div>

      <div id="map"></div>

      <!-- Legend with toggles -->
      <div class="legend">
        <label class="lg-toggle"><input id="lg24" type="checkbox" checked>
          <span class="dot dot24"></span> 24/7 / emergency
        </label>
        <label class="lg-toggle"><input id="lgOpen" type="checkbox" checked>
          <span class="dot dotOpen"></span> Otwarte teraz
        </label>
        <label class="lg-toggle"><input id="lgElse" type="checkbox" checked>
          <span class="dot dotElse"></span> Pozostali
        </label>
      </div>
    </section>

    <aside class="card side">
      <div class="head"><div style="font-weight:800">Lista</div><div id="count" class="muted">â€“</div></div>
      <div class="list" id="list"><div class="empty">Kliknij â€ğŸ“ Lokalizacjaâ€ lub â€Szukaj w tym widokuâ€.</div></div>
      <div class="head" style="justify-content:center">
        <a class="btn" href="tel:112">ğŸ“ 112</a>
        <a class="btn" href="https://www.google.com/search?q=pogotowie+stomatologiczne" target="_blank" rel="noopener">ğŸš‘ Pogotowie stomatologiczne</a>
      </div>
    </aside>
  </div>

  <script>
    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    function esc(s){ return (s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function escA(s){ return (s||'').replace(/"/g,'&quot;'); }
    function ohIsOpen(oh){ try{ if(!oh) return null; const ohObj=new opening_hours(oh); return ohObj.getState(new Date()); }catch(e){ return null } }

    // TRIAGE â€” interaktywny
    const painSeg=$('#pain-seg'); for(let i=0;i<=10;i++){ const b=document.createElement('button'); b.className='seg-btn'; b.dataset.val=i; b.textContent=i; painSeg.appendChild(b); }
    function triageEval(){
      const p=+($('.seg-btn.active[data-val]', painSeg)?.dataset.val||0);
      const s=$('#swelling-seg .seg-btn.active')?.dataset.val || 'no';
      const t=$('#trauma-seg .seg-btn.active')?.dataset.val || 'no';
      let score=(p>=8?2:(p>=5?1:0))+(s==='high'?2:(s==='mild'?1:0))+(t==='bleeding'?2:(t==='recent'?1:0));
      const badge=$('#t-badge'), out=$('#t-out');
      if(score>=4){ badge.className='badge red'; badge.textContent='Pilne'; out.textContent='Skontaktuj siÄ™ PILNIE z gabinetem 24/7. W razie dusznoÅ›ci/gorÄ…czki â€“ SOR/112.'; }
      else if(score>=2){ badge.className='badge amber'; badge.textContent='DziÅ›'; out.textContent='ZnajdÅº gabinet otwarty teraz i umÃ³w wizytÄ™ na dziÅ›. Zimny okÅ‚ad policzka, leki p/bÃ³lowe wg ulotki.'; }
      else{ badge.className='badge green'; badge.textContent='Planowo'; out.textContent='UmÃ³w wizytÄ™ planowÄ…. Unikaj skrajnych temp. napojÃ³w. Dbaj o higienÄ™ jamy ustnej.'; }
    }
    function segActivate(box, target){ $$('.seg-btn',box).forEach(el=>el.classList.toggle('active', el===target)); triageEval(); }
    painSeg.addEventListener('click', e=>{ if(e.target.matches('.seg-btn')) segActivate(painSeg, e.target); });
    $('#swelling-seg').addEventListener('click', e=>{ if(e.target.matches('.seg-btn')) segActivate($('#swelling-seg'), e.target); });
    $('#trauma-seg').addEventListener('click', e=>{ if(e.target.matches('.seg-btn')) segActivate($('#trauma-seg'), e.target); });
    painSeg.querySelector('.seg-btn[data-val="6"]').classList.add('active');
    $('#swelling-seg .seg-btn[data-val="no"]').classList.add('active');
    $('#trauma-seg .seg-btn[data-val="no"]').classList.add('active');
    triageEval();

    // MAPA + DANE
    let map, layer24, layerOpen, layerElse, userMarker, allPts=[];
    let R=6;
    const initCenter = {lat:52.2297, lon:21.0122}; // Warszawa
    initMap();

    function initMap(){
      map=L.map('map',{zoomControl:true,scrollWheelZoom:true}).setView([initCenter.lat, initCenter.lon], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
      layer24=L.layerGroup().addTo(map); layerOpen=L.layerGroup().addTo(map); layerElse=L.layerGroup().addTo(map);

      $('#btn-geoloc').addEventListener('click', geolocNow);
      $('#btn-search-viewport').addEventListener('click', ()=>{ const c=map.getCenter(); fetchDentists(c.lat, c.lng); updateGM(c.lat,c.lng); });
      $('#radius').addEventListener('input', e=>{ R=+e.target.value; $('#radiusVal').textContent=R+' km'; const c=map.getCenter(); fetchDentists(c.lat,c.lng); });
      ['f-24','f-open','f-nfz','f-wheel'].forEach(id=> $('#'+id).addEventListener('change', applyFilters));

      updateGM(initCenter.lat, initCenter.lon);
    }

    function geolocNow(){
      if(!navigator.geolocation){ const c=map.getCenter(); fetchDentists(c.lat,c.lng); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        if(userMarker) map.removeLayer(userMarker);
        userMarker=L.marker([lat,lon],{title:'Twoja lokalizacja'}).addTo(map);
        map.setView([lat,lon],14);
        fetchDentists(lat,lon); updateGM(lat,lon);
      }, _=>{ const c=map.getCenter(); fetchDentists(c.lat,c.lng); }, {enableHighAccuracy:true,timeout:9000,maximumAge:30000});
    }

    function updateGM(lat,lon){
      const z=14, base='@'+lat+','+lon+','+z+'z';
      $('#gm-24').href='https://www.google.com/maps/search/stomatolog+24h/'+base;
      $('#gm-all').href='https://www.google.com/maps/search/stomatolog/'+base;
    }

    function fetchDentists(lat,lon){
      const radius=Math.round(R*1000);
      const q=`[out:json][timeout:25];
        (node["amenity"="dentist"](around:${radius},${lat},${lon});
         way["amenity"="dentist"](around:${radius},${lat},${lon});
         relation["amenity"="dentist"](around:${radius},${lat},${lon}););
        out center 200;`;
      setListInfo('Szukam gabinetÃ³wâ€¦');
      layer24.clearLayers(); layerOpen.clearLayers(); layerElse.clearLayers();
      fetch('https://overpass-api.de/api/interpreter?data='+encodeURIComponent(q))
        .then(r=>r.json()).then(json=>{ allPts=normalize(json); applyFilters(); })
        .catch(_=> setListInfo('BÅ‚Ä…d pobierania danych (Overpass). SprÃ³buj ponownie.'));
    }

    function normalize(data){
      if(!data || !data.elements) return [];
      return data.elements.map(el=>{
        const c = el.type==='node' ? [el.lat, el.lon] : [el.center.lat, el.center.lon];
        const t = el.tags || {};
        const nfz = (t['healthcare:insurance:pl:NFZ']==='yes') || /\bNFZ\b/i.test(t.name||'') || /\bnfz\b/i.test(t.operator||'');
        const wheel = (t.wheelchair==='yes');
        const twenty4 = (t.opening_hours==='24/7') || /24.?7/.test(t.opening_hours||'');
        const emergency = (t.emergency==='yes') || /emergency/i.test(t.name||'');
        return {
          id:el.id, lat:c[0], lon:c[1],
          name:t.name || 'Gabinet stomatologiczny',
          phone:t.phone || t['contact:phone'] || null,
          website:t.website || t['contact:website'] || null,
          addr:[t['addr:street'],t['addr:housenumber'],t['addr:city']].filter(Boolean).join(' ') || (t['addr:full']||''),
          oh:t.opening_hours || null, nfz, wheel, twenty4, emergency
        };
      });
    }

    function setListInfo(msg){ $('#list').innerHTML='<div class="empty">'+msg+'</div>'; }

    function popupHTML(p){
      const dest = encodeURIComponent(p.lat+','+p.lon);
      const open = ohIsOpen(p.oh);
      return `
        <div class="name">${esc(p.name)}</div>
        <div class="meta">${esc(p.addr||'')}</div>
        ${p.oh?('<div class="meta">ğŸ•’ '+esc(p.oh)+'</div>'):''}
        <div style="margin-top:6px">
          ${p.twenty4?'<span class="tag hi">24/7</span>':''}
          ${p.emergency?'<span class="tag hi">emergency</span>':''}
          ${open===true?'<span class="tag open">otwarte teraz</span>':(open===false?'<span class="tag closed">zamkniÄ™te</span>':'')}
          ${p.nfz?'<span class="tag">NFZ</span>':''}
          ${p.wheel?'<span class="tag">â™¿</span>':''}
        </div>
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
          ${p.phone?('<a class="btn" href="tel:'+encodeURIComponent(p.phone)+'">ğŸ“ ZadzwoÅ„</a>'):''}
          <a class="btn" target="_blank" rel="noopener" href="https://www.google.com/maps/dir/?api=1&destination=${dest}">ğŸ—ºï¸ Trasa</a>
          ${p.website?('<a class="btn" target="_blank" rel="noopener" href="'+escA(p.website)+'">ğŸŒ Strona</a>'):''}
        </div>`;
    }

    function applyFilters(){
      const only24=$('#f-24').checked, openNow=$('#f-open').checked, onlyNFZ=$('#f-nfz').checked, onlyWheel=$('#f-wheel').checked;
      layer24.clearLayers(); layerOpen.clearLayers(); layerElse.clearLayers();
      const pts = allPts.slice().sort((a,b)=>{
        const aOpen=ohIsOpen(a.oh), bOpen=ohIsOpen(b.oh);
        const sA=(a.twenty4?3:0)+(a.emergency?2:0)+(aOpen===true?1:0)+(a.nfz?0.5:0);
        const sB=(b.twenty4?3:0)+(b.emergency?2:0)+(bOpen===true?1:0)+(b.nfz?0.5:0);
        return sB-sA;
      });

      const items=[]; let shown=0;
      pts.forEach(p=>{
        const isOpen = ohIsOpen(p.oh);
        if(only24 && !p.twenty4 && !p.emergency) return;
        if(openNow && isOpen!==true) return;
        if(onlyNFZ && !p.nfz) return;
        if(onlyWheel && !p.wheel) return;

        const color = p.twenty4||p.emergency ? '#2ce39b' : (isOpen===true ? '#73d2ff' : '#b9a6ff');
        const m = L.circleMarker([p.lat,p.lon], {radius:8, color, weight:2, fillColor:color, fillOpacity:.32});
        m.bindPopup(popupHTML(p));
        if(p.twenty4 || p.emergency) layer24.addLayer(m); else if(isOpen===true) layerOpen.addLayer(m); else layerElse.addLayer(m);
        items.push(popupHTML(p));
        shown++;
      });

      renderList(items);
      $('#count').textContent = shown;
      if(shown===0) setListInfo('Brak wynikÃ³w â€” zmieÅ„ promieÅ„ lub odznacz filtry.');
      // zapewnij zgodnoÅ›Ä‡ z legend toggle
      applyLegendVisibility();
    }

    function renderList(items){
      const box=$('#list'); box.innerHTML='';
      if(items.length===0){ setListInfo('Brak wynikÃ³w â€” zmieÅ„ promieÅ„ lub odznacz filtry.'); return; }
      items.forEach(h=>{ const d=document.createElement('div'); d.className='dent'; d.innerHTML=h; box.appendChild(d); });
    }

    // --- Legend toggles (pokazywanie/ukrywanie warstw) ---
    const lg24 = document.getElementById('lg24');
    const lgOpen = document.getElementById('lgOpen');
    const lgElse = document.getElementById('lgElse');

    function applyLegendVisibility(){
      if(lg24 && layer24){ lg24.checked ? map.addLayer(layer24) : map.removeLayer(layer24); }
      if(lgOpen && layerOpen){ lgOpen.checked ? map.addLayer(layerOpen) : map.removeLayer(layerOpen); }
      if(lgElse && layerElse){ lgElse.checked ? map.addLayer(layerElse) : map.removeLayer(layerElse); }
    }
    [lg24, lgOpen, lgElse].forEach(el=> el && el.addEventListener('change', applyLegendVisibility));

    // start
    applyLegendVisibility();

  </script>
</body>
</html>
